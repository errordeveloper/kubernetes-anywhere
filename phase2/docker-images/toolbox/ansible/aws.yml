- hosts: auto
  tasks:

  - name: Gather general EC2 facts
    action: ec2_facts

  - name: Fetch all metadata about this instance
    ec2_remote_facts:
      region: "{{ ansible_ec2_placement_region }}"
      filters:
        "instance-id": "{{ ansible_ec2_instance_id }}"
    register: ec2_describe_instance
    delegate_to: localhost

  - name: Store cluster membership facts for this instance
    set_fact:
      kubernetes_cluster: "{{ ec2_describe_instance.instances[0].tags.KubernetesCluster }}"
      kubernetes_role: "{{ ec2_describe_instance.instances[0].tags.Name }}"

  - name: Fetch metadata about all other cluster members
    ec2_remote_facts:
      region: "{{ ansible_ec2_placement_region }}"
      filters:
        "tag:KubernetesCluster": "{{ kubernetes_cluster }}"
    register: ec2_describe_cluster
    delegate_to: localhost

  - name: Set cluster member list
    set_fact:
      kubernetes_cluster_memebers: "{{ ec2_describe_cluster.instances | map(attribute='private_ip_address') | list }}"

  - name: Install all systemd units
    copy: src="{{ item }}" dest="/etc/systemd/system/" owner="root" group="root" mode="0644"
    with_fileglob:
      - "/etc/toolbox/systemd-units/common/*"
      - "/etc/toolbox/systemd-units/ec2/*"
      - "/etc/toolbox/systemd-units/with-pki/*"
